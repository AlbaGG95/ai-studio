#!/usr/bin/env node

import { mkdirSync, writeFileSync, existsSync } from "fs";
import path from "path";

const VALID_TYPES = [
  "idle_rpg",
  "clicker",
  "runner",
  "tower_defense",
  "trivia",
  "platformer_simple",
  "match3",
];

const [, , templateId, gameType] = process.argv;

if (!templateId || !gameType) {
  console.error("Usage: pnpm gen:template <id> <type>");
  process.exit(1);
}

if (!VALID_TYPES.includes(gameType)) {
  console.error(`Invalid type. Use one of: ${VALID_TYPES.join(", ")}`);
  process.exit(1);
}

const root = process.cwd();
const dir = path.join(root, "lib", "templates", templateId);

if (existsSync(dir)) {
  console.error(`Directory already exists: ${dir}`);
  process.exit(1);
}

mkdirSync(dir, { recursive: true });

const indexTs = `import { GameSpec, GameType } from "../../gameSpec";
import { GeneratedGame, GameTemplate, TemplateId } from "../registry";

export const templateId = "${templateId}" as TemplateId;

export const template: GameTemplate = {
  id: templateId,
  type: "${gameType}" as GameType,
  canHandle: (spec: GameSpec) => spec.type === "${gameType}",
  build: (spec: GameSpec): GeneratedGame => {
    return {
      route: "/play?templateId=${templateId}",
      config: {
        title: spec.title,
        content: spec.content,
        theme: spec.theme,
      },
      notes: ["Generated by scaffold: adjust build logic to map spec -> runtime config."],
    };
  },
};

export const exampleSpec: GameSpec = {
  version: "1.0",
  title: "Example ${templateId}",
  type: "${gameType}" as GameType,
  theme: { name: "Default", tone: "casual" },
  rules: {
    objective: "Describe objective",
    controls: ["Add controls"],
    winCondition: "Define win",
  },
  content: { entities: [] },
  ui: { layout: "single_screen" },
};
`;

const specJson = `{
  "version": "1.0",
  "title": "Example ${templateId}",
  "type": "${gameType}",
  "theme": { "name": "Default", "tone": "casual" },
  "rules": {
    "objective": "Describe objective",
    "controls": ["Add controls"],
    "winCondition": "Define win"
  },
  "content": { "entities": [] },
  "ui": { "layout": "single_screen" }
}
`;

const testTs = `import assert from "node:assert/strict";
import { template, exampleSpec } from "./index";

assert(template.canHandle(exampleSpec));
const generated = template.build(exampleSpec);
assert(generated.route.includes("${templateId}"));
console.log("Template ${templateId} basic test passed");
`;

writeFileSync(path.join(dir, "index.ts"), indexTs, "utf-8");
writeFileSync(path.join(dir, "spec.example.json"), specJson, "utf-8");
writeFileSync(path.join(dir, "template.test.ts"), testTs, "utf-8");

console.log(`Scaffold created at ${dir}`);
console.log("Remember to add TemplateId entry and register the template in lib/templates/registry.ts");
